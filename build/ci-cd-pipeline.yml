trigger:
- master

stages:
- stage: Build
  displayName: Build and package solution binaries and other files

  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - task: CopyFiles@2
      displayName: "Copy deployment files to artifact staging folder"
      inputs:
        SourceFolder: 'infra'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/infra'

    - task: CopyFiles@2
      displayName: "Copy deployment scripts to artifact staging folder"
      inputs:
        SourceFolder: 'scripts'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/scripts'
  
    - publish: $(Build.ArtifactStagingDirectory)
      displayName: 'Publish contents of $(Build.ArtifactStagingDirectory) to artifact repo in Azure DevOps'
      artifact: drop

- stage: Deploy
  displayName: Deploy to DEV
  dependsOn: Build
  condition: succeeded()

  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: 'development'

    strategy:
      runOnce:
        deploy:
          steps:            
          - task: Bash@3
            displayName: "Rename .azcli file to .sh file so it can be executed in next step"
            inputs:
              targetType: 'inline'
              script: |
                mv deploy-infra.azcli deploy-infra.sh
                ls -als
              workingDirectory: '$(Agent.BuildDirectory)/drop/infra'

          - task: AzureCLI@2
            displayName: "Deploy .azcli deployment script"
            inputs:
              azureSubscription: '$(azure-subscription)'
              scriptType: 'bash/pscore'
              scriptLocation: 'scriptPath'
              scriptPath: 'deploy-infra.sh'
              workingDirectory: '$(Agent.BuildDirectory)/drop/infra'
